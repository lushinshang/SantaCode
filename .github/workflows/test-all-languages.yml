name: Test All Language Docker Images

on:
  # Áï∂ runner.py Ë¢´‰øÆÊîπÊôÇËá™ÂãïËß∏Áôº
  push:
    paths:
      - 'core/runner.py'
      - '.github/workflows/test-all-languages.yml'
  pull_request:
    paths:
      - 'core/runner.py'
      - '.github/workflows/test-all-languages.yml'
  # ÂÖÅË®±ÊâãÂãïËß∏Áôº
  workflow_dispatch:

jobs:
  test-all-images:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Test All Language Docker Images
        run: |
          echo "=========================================="
          echo "Testing All Language Configurations"
          echo "=========================================="

          # Ê∏¨Ë©¶ÊâÄÊúâ example-santa ÁõÆÈåÑ‰∏ãÁöÑÊ™îÊ°à
          EXAMPLE_DIR="submissions/example-santa"
          FAILED_TESTS=()
          PASSED_TESTS=()

          # ÊâæÂá∫ÊâÄÊúâÊ∏¨Ë©¶Ê™îÊ°à
          TEST_FILES=$(find $EXAMPLE_DIR -type f \( -name "*.py" -o -name "*.js" -o -name "*.go" -o -name "*.rb" -o -name "*.sh" -o -name "*.java" -o -name "*.kt" -o -name "*.swift" -o -name "*.c" -o -name "*.cpp" -o -name "*.cs" -o -name "*.rs" \))

          for file in $TEST_FILES; do
            echo ""
            echo "=================================================="
            LANG=$(basename "$file" | sed 's/.*\.//')
            echo "üß™ Testing: $file (.$LANG)"
            echo "=================================================="

            if python3 core/runner.py "$file" > /tmp/output.txt 2>&1; then
              echo "‚úÖ SUCCESS: .$LANG works correctly"
              PASSED_TESTS+=("‚úÖ .$LANG - $(basename $file)")

              # È©óË≠âËº∏Âá∫
              if cat /tmp/output.txt | python3 challenges/2025-tree/validator.py 2>&1; then
                echo "‚úÖ Output validation passed"
              else
                echo "‚ö†Ô∏è  Warning: Output validation failed (but Docker image works)"
              fi
            else
              echo "‚ùå FAILED: .$LANG encountered an error"
              echo "Error details:"
              cat /tmp/output.txt
              FAILED_TESTS+=("‚ùå .$LANG - $(basename $file)")
            fi
          done

          echo ""
          echo "=========================================="
          echo "üìä Test Summary"
          echo "=========================================="
          echo ""
          echo "‚úÖ Passed Tests (${#PASSED_TESTS[@]}):"
          for test in "${PASSED_TESTS[@]}"; do
            echo "  $test"
          done

          if [ ${#FAILED_TESTS[@]} -gt 0 ]; then
            echo ""
            echo "‚ùå Failed Tests (${#FAILED_TESTS[@]}):"
            for test in "${FAILED_TESTS[@]}"; do
              echo "  $test"
            done
            echo ""
            echo "=========================================="
            echo "‚ùå Some language tests failed!"
            echo "Please check the Docker image configurations in core/runner.py"
            echo "=========================================="
            exit 1
          else
            echo ""
            echo "=========================================="
            echo "‚úÖ All language tests passed!"
            echo "All Docker images are working correctly."
            echo "=========================================="
          fi
